---
title: "Vaccination study analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, message=FALSE}
# Setup the working directory as the directory of the RProj file
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

**Load libraries**
```{r Load libraries, message=FALSE, warning=FALSE}
suppressMessagesAndWarnings <- function(x) suppressMessages(suppressWarnings(x))

suppressMessagesAndWarnings(library(arm))
suppressMessagesAndWarnings(library(lmec))
suppressMessagesAndWarnings(library(tidymodels))
suppressMessagesAndWarnings(library(dotwhisker))

suppressMessagesAndWarnings(library(tidyverse))
suppressMessagesAndWarnings(library(data.table))
suppressMessagesAndWarnings(library(glue))
suppressMessagesAndWarnings(library(readxl))

suppressMessagesAndWarnings(library(patchwork))
suppressMessagesAndWarnings(library(ggpubr))
suppressMessagesAndWarnings(library(cowplot))
suppressMessagesAndWarnings(library(ggforce))
suppressMessagesAndWarnings(library(ggbeeswarm))
suppressMessagesAndWarnings(library(latex2exp))
```

**Read data**
```{r Read data}
quantiferon <- read_csv("data/processed/vaccination_study_public/quantiferon.csv") %>% suppressMessagesAndWarnings()

serology <- read_csv("data/processed/vaccination_study_public/serology.csv") %>% 
  mutate(status = ifelse(status == "naive", "naive", "experienced"),
         time_point = str_extract(time_point, "[0-9]") %>% as.numeric %>% {.-1} %>% paste0("T", .)
         ) %>% suppressMessagesAndWarnings()

clinical_data <- read_csv("data/processed/vaccination_study_public/clinical_data.csv") %>% suppressMessagesAndWarnings()
```

**Estimate NT50 decay rate post-second dose of vaccine**
```{r Estimate NT50 decay rate post-second dose of vaccine, echo = TRUE, results = 'hide'}
decay_estimation_df <- serology %>% filter(time_point != "T0")
decay_estimation_df <- decay_estimation_df %>%
  group_by(patid) %>%
  mutate(days_after_2nd_shot = days_after_vaccination - days_after_vaccination[time_point == "T1"]) %>%
  filter(time_point != "T1")
break_point <- median(decay_estimation_df$days_after_2nd_shot)
decay_estimation_df <- mutate(decay_estimation_df, s = ifelse(days_after_2nd_shot < break_point, 0, days_after_2nd_shot - break_point))
decay_estimation_df <- decay_estimation_df %>% select(patid, days_after_2nd_shot, neutralization_titre, igg_antispike, status, s)

set.seed(179)
# for neutralization
decay_estimation_df_nt50 <- filter(decay_estimation_df, !is.na(neutralization_titre))
cens <- ifelse(decay_estimation_df_nt50$neutralization_titre == 0, 1, 0) %>% as.numeric() # censoring indicator, put 1 if the value is below threshold
y <- log(10^decay_estimation_df_nt50$neutralization_titre) # dependent variable to fit (log of neutralization)
cluster <- decay_estimation_df_nt50$patid %>%
  factor(labels = 1:length(unique(decay_estimation_df_nt50$patid))) %>%
  as.numeric()
id <- unique(cluster)
day <- decay_estimation_df_nt50$days_after_2nd_shot %>% as.numeric() # day of the 2nd shot is day 0 in the fitting
intercept_matrix <- matrix(rep(1, length(y)), ncol = 1)
group <- ifelse(decay_estimation_df_nt50$status == "experienced", 1, 0)

# X is the design matrix for the fixed effect; group is a binary variable for experienced vs naive data, interaction with day accounts for differences in the decay rate
# Z is the design matrix for the random effects for intercept and slope
fit_linear_different_rate_nt50 <- lmec(
  yL = y,
  cens = cens,
  X = cbind(intercept_matrix, day, group, group * day),
  Z = cbind(intercept_matrix, day),
  cluster = cluster,
  method = "ML", varstruct = "unstructured"
)

# X is the design matrix for the fixed effect; difference between groups is only in the intercept
# Z is the design matrix for the random effects for intercept and slope
fit_linear_same_rate_nt50 <- lmec(
  yL = y,
  cens = cens,
  X = cbind(intercept_matrix, day, group),
  Z = cbind(intercept_matrix, day),
  cluster = cluster,
  method = "ML", varstruct = "unstructured"
)


# Compute test statistic: -2 * [loglikelihood(nested)-loglikelihood(complex)].
# Test statistic follows a chi-squared distribution with degrees of freedom equal to the difference in the number of free parameters between complex and nested models.

# Is single-slope grouping model preferred over single-slope non-grouping model?
pchisq(-2 * (fit_linear_same_rate_nt50$loglik - fit_linear_different_rate_nt50$loglik),
  df = length(fit_linear_different_rate_nt50$beta) - length(fit_linear_same_rate_nt50$beta),
  lower.tail = FALSE
)
# 0.44 => no, so decay is not detected as different for experienced and naive if using single-slope model
```

**Estimate IgG decay rate post-second dose of vaccine**
```{r Estimate IgG decay rate post-second dose of vaccine, echo = TRUE, results = 'hide'}
# for IGG
decay_estimation_df_igg <- filter(decay_estimation_df, !is.na(igg_antispike)) %>% mutate(igg_antispike = log(igg_antispike), patid = as.factor(patid))

cens <- rep(0, nrow(decay_estimation_df_igg)) # censoring indicator, put 1 if the value is below threshold
y <- decay_estimation_df_igg$igg_antispike # dependent variable to fit (log of neutralization)
cluster <- decay_estimation_df_igg$patid %>%
  factor(labels = 1:length(unique(decay_estimation_df_igg$patid))) %>%
  as.numeric()
id <- unique(cluster)
day <- decay_estimation_df_igg$days_after_2nd_shot %>% as.numeric() # day of the 2nd shot is day 0 in the fitting
intercept_matrix <- matrix(rep(1, length(y)), ncol = 1)
group <- ifelse(decay_estimation_df_igg$status == "experienced", 1, 0)
# X is the design matrix for the fixed effect; group is a binary variable for experienced vs naive data, interaction with day accounts for differences in the decay rate
# Z is the design matrix for the random effects for intercept and slope
fit_linear_different_rate_igg <- lmec(
  yL = y,
  cens = cens,
  X = cbind(intercept_matrix, day, group, group * day),
  Z = cbind(intercept_matrix, day),
  cluster = cluster,
  method = "ML", varstruct = "unstructured"
)

# X is the design matrix for the fixed effect; difference between groups is only in the intercept
# Z is the design matrix for the random effects for intercept and slope
fit_linear_same_rate_igg <- lmec(
  yL = y,
  cens = cens,
  X = cbind(intercept_matrix, day, group),
  Z = cbind(intercept_matrix, day),
  cluster = cluster,
  method = "ML", varstruct = "unstructured"
)

# Is single-slope grouping model preferred over single-slope non-grouping model?
pchisq(-2 * (fit_linear_same_rate_igg$loglik - fit_linear_different_rate_igg$loglik),
  df = length(fit_linear_different_rate_igg$beta) - length(fit_linear_same_rate_igg$beta),
  lower.tail = FALSE
)
# 0.06 => no, so decay is not detected as different for experienced and naive if using single-slope model
```

```{r}
glue("NT50 half-life is {round( -log(2) / (fit_linear_same_rate_nt50$beta[2]))} days")
glue("anti-S IgG half-life is {round( -log(2) / (fit_linear_same_rate_igg$beta[2]))} days")
```

**Plot IgG/NT50 dynamics by months**
```{r Plot IgG/NT50 dynamics by months, echo = TRUE, results = 'hide'}
all_points_nt50 <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  mutate(status = case_when(
    status == "naive" ~ glue("naive\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'naive'))}"),
    status == "experienced" ~ glue("experienced\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'experienced'))}")
  )) %>%
  ggplot(aes(
    x = days_after_vaccination,
    y = neutralization_titre,
    group = patid,
    fill = status
  )) +
  geom_line(alpha = 0.3, aes(color = status)) +
  geom_point(alpha = 0.6, shape = 21, aes(color = status)) +
  theme_pubr(base_size = 15) +
  theme(legend.position = "none", axis.title.y = element_blank()) +
  xlab("# days post-vaccine") +
  scale_color_manual(values = c("#D55E00", "#56B4E9")) +
  scale_fill_manual(values = c("#D55E00", "#56B4E9"))

mean_points_nt50 <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  mutate(weeks = round(days_after_vaccination / 7)) %>%
  select(neutralization_titre, status, weeks) %>%
  mutate(months = case_when(
    weeks == 0 ~ 0,
    between(weeks, 3, 4) ~ 1,
    between(weeks, 5, 6) ~ 1.5,
    between(weeks, 7, 9) ~ 2,
    between(weeks, 26, 29) ~ 6
  )) %>%
  filter(!is.na(months)) %>%
  select(neutralization_titre, status, months) %>%
  mutate(status = case_when(
    status == "naive" ~ glue("naive\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'naive'))}"),
    status == "experienced" ~ glue("experienced\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'experienced'))}")
  )) %>%
  ggline(
    x = "months",
    y = "neutralization_titre",
    color = "status",
    add = c("median", "jitter"), shape = 15,
    palette = c("#D55E00", "#56B4E9"),
    add.params = list(alpha = 0.3, size = 1, shape = 10), size = 1
  ) +
  theme_pubr(base_size = 15) +
  xlab("# months post-vaccine") +
  stat_compare_means(aes(group = status),
    method = "wilcox.test",
    method.args = list(alternative = "greater"),
    label = "p.signif",
    hide.ns = TRUE
  ) +
  scale_x_discrete(limits = factor(seq(0, 6, 0.5)), labels = sapply(1:length(seq(0, 6, 0.5)), function(i) ifelse(i %% 2 == 0, "", seq(0, 6, 0.5)[i]))) +
  ylab(TeX("$_{-log_{10}}$ NT50")) +
  annotate(geom = "text", x = 8, y = 3, label = expression("t"[1 / 2] * " = " * "45 days"), size = 6) +
  theme(legend.position = "top", legend.title = element_blank()) +
  geom_circle(aes(x0=13,y0=0,r=0.3), inherit.aes = FALSE) + 
  annotate(geom = "text", x = 10.5, y = 0.5, label = "non-neutralizing individuals", size = 5)

all_points_igg <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  mutate(
    igg_antispike = log10(igg_antispike),
    status = case_when(
      status == "naive" ~ glue("naive\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'naive'))}"),
      status == "experienced" ~ glue("experienced\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'experienced'))}")
    )
  ) %>%
  ggplot(aes(
    x = days_after_vaccination,
    y = igg_antispike,
    group = patid,
    fill = status
  )) +
  geom_line(alpha = 0.3, aes(color = status)) +
  geom_point(alpha = 0.6, shape = 21, aes(color = status)) +
  theme_pubr(base_size = 15) +
  theme(legend.position = "none", axis.title.y = element_blank()) +
  xlab("# days post-vaccine") +
  scale_color_manual(values = c("#D55E00", "#56B4E9")) +
  scale_fill_manual(values = c("#D55E00", "#56B4E9"))

mean_points_igg <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  mutate(weeks = round(days_after_vaccination / 7)) %>%
  select(igg_antispike, status, weeks) %>%
  mutate(months = case_when(
    weeks == 0 ~ 0,
    between(weeks, 3, 4) ~ 1,
    between(weeks, 5, 6) ~ 1.5,
    between(weeks, 7, 9) ~ 2,
    between(weeks, 26, 29) ~ 6
  )) %>%
  filter(!is.na(months)) %>%
  select(igg_antispike, status, months) %>%
  mutate(
    igg_antispike = log10(igg_antispike),
    status = case_when(
      status == "naive" ~ glue("naive\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'naive'))}"),
      status == "experienced" ~ glue("experienced\nn = {nrow(filter(serology, !is.na(days_after_vaccination), time_point == 'T0', status == 'experienced'))}")
    )
  ) %>%
  ggline(
    x = "months",
    y = "igg_antispike",
    color = "status",
    add = c("median", "jitter"), shape = 15,
    palette = c("#D55E00", "#56B4E9"),
    add.params = list(alpha = 0.3, size = 1, shape = 10), size = 1
  ) +
  theme_pubr(base_size = 15) +
  xlab("# months post-vaccine") +
  stat_compare_means(aes(group = status),
    method = "wilcox.test",
    method.args = list(alternative = "greater"),
    label = "p.signif",
    hide.ns = TRUE
  ) +
  scale_x_discrete(limits = factor(seq(0, 6, 0.5)), labels = sapply(1:length(seq(0, 6, 0.5)), function(i) ifelse(i %% 2 == 0, "", seq(0, 6, 0.5)[i]))) +
  annotate(geom = "text", x = 8, y = 4, label = expression("t"[1 / 2] * " = " * "55 days"), size = 6) +
  theme(legend.position = "top", legend.title = element_blank()) +
  ylab(TeX("$_{log_{10}}$ anti-S IgG $_{(BAU/ml)}$"))


PLOT_serology_dynamics <-
  ggarrange(mean_points_igg, all_points_igg,
    mean_points_nt50, all_points_nt50,
    common.legend = TRUE, legend = "top",
    legend.grob = get_legend(mean_points_igg),
    labels = c("A", "B", "C", "D"),
    label.x = c(0, -0.025, 0, -0.025)
  )
```


```{r, echo = TRUE, results = 'hide'}
patients_wo_neutralization_after_1st_dose <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  mutate(weeks = round(days_after_vaccination / 7)) %>%
  mutate(months = case_when(
    weeks == 0 ~ 0,
    between(weeks, 3, 4) ~ 1,
    between(weeks, 5, 6) ~ 1.5,
    between(weeks, 7, 9) ~ 2,
    between(weeks, 26, 29) ~ 6
  )) %>%
  filter(neutralization_titre == 0 & months == 1) %>%
  pull(patid)

patients_wo_neutralization_after_halfayear <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  mutate(weeks = round(days_after_vaccination / 7)) %>%
  mutate(months = case_when(
    weeks == 0 ~ 0,
    between(weeks, 3, 4) ~ 1,
    between(weeks, 5, 6) ~ 1.5,
    between(weeks, 7, 9) ~ 2,
    between(weeks, 26, 29) ~ 6
  )) %>%
  filter(neutralization_titre == 0 & months == 6) %>%
  pull(patid)

patients_wo_neutralization_at_all <-
  intersect(patients_wo_neutralization_after_1st_dose, patients_wo_neutralization_after_halfayear)
```

**Get the IgG boundary value for neutralizing-after-6mths-vs-others**
```{r Get the IgG boundary value for neutralizing-after-6mths-vs-others, echo = TRUE, results = 'hide'}
non_neutr_n <-
  serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  filter(time_point == "T4") %>%
  pull(patid) %>%
  .[. %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear)] %>%
  length()

neutr_n <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  filter(time_point == "T4") %>%
  pull(patid) %>%
  .[!. %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear)] %>%
  length()

df <-
  serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  filter(time_point == "T4") %>%
  transmute(
    igg_antispike = log10(igg_antispike),
    neutralization_status = as.factor(case_when(
      patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ glue("not neutralizing\nafter half-a-year\nn = {non_neutr_n}"),
      TRUE ~ glue("neutralizing\nafter half-a-year\nn = {neutr_n}")
    ))
  )

md <- glm(neutralization_status ~ igg_antispike, data = df, family = binomial)

boundary_value <- 10^(-coef(md)[1] / coef(md)[2])

set.seed(179)
log_md <- logistic_reg()
log_fit <- log_md %>% fit(neutralization_status ~ igg_antispike, data = df)

set.seed(179)
folds <- vfold_cv(df, v = 5)
log_wf <-
  workflow() %>%
  add_model(log_md) %>%
  add_formula(neutralization_status ~ igg_antispike)

log_fit_rs <-
  log_wf %>%
  fit_resamples(folds, control = control_resamples(save_pred = TRUE))
sens_spec <- sapply(log_fit_rs$.predictions, function(x) {
  rbind(
    sens(x, estimate = .pred_class, truth = neutralization_status),
    yardstick::spec(x, estimate = .pred_class, truth = neutralization_status)
  ) %>% pull(.estimate)
})
rownames(sens_spec) <- c("sens", "spec")
colnames(sens_spec) <- paste0("cv", 1:5)

gmean <- apply(sens_spec, 2, prod) %>%
  sqrt() %>%
  mean() %>%
  round(2)
sens_spec <- t(sens_spec) %>%
  as_tibble() %>%
  transmute(
    sens_mean = mean(sens),
    sens_sd = sd(sens),
    spec_mean = mean(spec),
    spec_sd = sd(spec)
  ) %>%
  distinct() %>%
  {
    100 * .
  } %>%
  round()


p1 <- serology %>%
  filter(!is.na(days_after_vaccination)) %>%
  ungroup() %>%
  mutate(
    weeks = round(days_after_vaccination / 7),
    neutralization = as.factor(case_when(
      patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ glue("non-neutralizing after 6 months\nn = {non_neutr_n}"),
      TRUE ~ glue("neutralizing after 6 months\nn = {neutr_n}")
    ))
  ) %>%
  select(igg_antispike, neutralization, weeks) %>%
  mutate(
    igg_antispike = log10(igg_antispike),
    months = case_when(
      weeks == 0 ~ 0,
      between(weeks, 3, 4) ~ 1,
      between(weeks, 5, 6) ~ 1.5,
      between(weeks, 7, 9) ~ 2,
      between(weeks, 26, 29) ~ 6
    )
  ) %>%
  select(igg_antispike, neutralization, months) %>%
  ggline(
    x = "months",
    y = "igg_antispike",
    color = "neutralization",
    add = c("median", "jitter"), shape = 15,
    palette = c("#00AFBB", "#E7B800", "#FC4E07", "#999999"),
    add.params = list(alpha = 0.3, size = 1, shape = 10), size = 1
  ) +
  stat_compare_means(aes(group = neutralization),
    method = "wilcox.test",
    method.args = list(alternative = "less"),
    label = "p.signif",
    hide.ns = TRUE
  ) +
  theme_pubr(base_size = 15) +
  xlab("# months post-vaccine") +
  scale_x_discrete(limits = factor(seq(0, 6, 0.5)), labels = sapply(1:length(seq(0, 6, 0.5)), function(i) ifelse(i %% 2 == 0, "", seq(0, 6, 0.5)[i]))) +
  ylab(TeX("$_{log_{10}}$ anti-S IgG $_{(BAU/ml)}$")) + theme(legend.text = element_text(size = 10), legend.title = element_text(size = 12), legend.spacing.x = unit(0.5, "cm")) +
  guides(color = guide_legend(label.position = "bottom")) +
  geom_hline(yintercept = log10(boundary_value), linetype = "dashed") +
  theme(legend.title = element_blank())

p2 <- ggplot(df, aes(x = igg_antispike, y = as.numeric(neutralization_status) - 1)) +
  geom_point(aes(color = neutralization_status), alpha = .3, size = 3, shape = 10) +
  scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07", "#999999")) +
  stat_smooth(method = "glm", se = TRUE, method.args = list(family = binomial), color = "grey50") +
  geom_vline(xintercept = log10(boundary_value), linetype = "dashed") +
  theme_pubr(base_size = 15) +
  theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank()) +
  scale_x_continuous(limits = range(p1$data$igg_antispike, na.rm = TRUE)) +
  coord_flip() +
  ylab("6 months post-vaccine") +
  scale_y_discrete(limits = c(0, 1), labels = c("", "")) +
  annotate("text", x = log10(boundary_value) - 0.3, y = 0.5, label = glue("{round(boundary_value)} BAU/ml"), size = 5) +
  annotate("text", x = 4.8, y = 0.75, label = "5-fold CV:", size = 5) +
  annotate("text",
    x = 4.4, y = 0.75,
    label = TeX(paste0("\\textit{sensitivity} = ", sens_spec$sens_mean, "\\pm{}", sens_spec$sens_sd, " %")), size = 5
  ) +
  annotate("text",
    x = 4, y = 0.75,
    label = TeX(paste0("\\textit{specificity} = ", sens_spec$spec_mean, "\\pm{}", sens_spec$spec_sd, " %")), size = 5
  ) +
  theme(
    legend.position = "none",
    axis.ticks.x = element_blank()
  )
```

**fig1**
```{r fig1, fig.width=12, fig.height=12}
PLOT_neutralizing_status_logreg <- ggarrange(p1, p2, common.legend = TRUE, legend = "right", widths = c(1.55, 1), labels = c("E", "F"), label.x = c(0, -0.025))

fig1 <- ggarrange(PLOT_serology_dynamics, PLOT_neutralizing_status_logreg,
  ncol = 1,
  heights = c(2, 1)
)

ggsave(path = "analysis/plots/vaccination_study/paper/",
       filename = "fig1.png",
       plot = fig1,
       width=12, height=12,
       device = "png", dpi=600)

fig1
```

**Look at class separation across time points: suppl_neutralizing_status_logreg**
```{r Look at class separation across time points: suppl_neutralizing_status_logreg, fig.width=6, fig.height=8}
class_separation <- vector("list", 5) %>% setNames(paste0("T", 0:4))
for (TIME_POINT in c(paste0("T", 0:4))) {
  df <-
    serology %>%
    filter(!is.na(days_after_vaccination)) %>%
    ungroup() %>%
    filter(time_point == TIME_POINT) %>%
    transmute(
      igg_antispike = log10(igg_antispike),
      neutralization_status = as.factor(case_when(
        patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ glue("non-neutralizing after 6 months\nn = {non_neutr_n}"),
        TRUE ~ glue("neutralizing after 6 months\nn = {neutr_n}")
      ))
    )

  md <- glm(neutralization_status ~ igg_antispike, data = df, family = binomial)
  boundary_value <- 10^(-coef(md)[1] / coef(md)[2])

  set.seed(179)
  log_md <- logistic_reg()
  log_fit <- log_md %>% fit(neutralization_status ~ igg_antispike, data = df)

  set.seed(179)
  folds <- vfold_cv(df, v = 5)
  log_wf <-
    workflow() %>%
    add_model(log_md) %>%
    add_formula(neutralization_status ~ igg_antispike)

  log_fit_rs <-
    log_wf %>%
    fit_resamples(folds, control = control_resamples(save_pred = TRUE))
  gmean <- sapply(log_fit_rs$.predictions, function(x) {
    rbind(
      sens(x, estimate = .pred_class, truth = neutralization_status),
      yardstick::spec(x, estimate = .pred_class, truth = neutralization_status)
    ) %>%
      pull(.estimate) %>%
      prod() %>%
      sqrt()
  }) %>%
    mean() %>%
    round(2)

  class_separation[[TIME_POINT]] <-
    ggplot(df, aes(x = igg_antispike, y = as.numeric(neutralization_status) - 1)) +
    geom_point(aes(color = neutralization_status), alpha = .3, size = 3) +
    scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07", "#999999")) +
    stat_smooth(method = "glm", se = TRUE, method.args = list(family = binomial), color = "grey50") +
    geom_vline(xintercept = log10(boundary_value), linetype = "dashed") +
    theme_pubr(base_size = 12) +
    theme(axis.text.y = element_blank()) +
    scale_x_continuous(limits = range(p1$data$igg_antispike, na.rm = TRUE)) +
    xlab(TeX("$_{log_{10}}$ anti-S IgG $_{(BAU/ml)}$")) +
    coord_flip() +
    ggtitle(TIME_POINT) +
    annotate("text", x = log10(boundary_value) - 0.2, y = 0.5, label = glue("{round(boundary_value)} BAU/ml"), size = 4) +
    annotate("text", x = 4.6, y = 0.5, label = glue("Logistic regression on IgG at {TIME_POINT}\nG-mean metric = {gmean} (5-fold CV)"), size = 4) +
    theme(legend.position = "top", legend.title = element_blank(), axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank())
}
PLOT <- ggarrange(class_separation[[1]], class_separation[[2]], class_separation[[3]], class_separation[[4]], common.legend = TRUE)

ggsave(path = "analysis/plots/vaccination_study/paper/",
       filename = "suppl_neutralizing_status_logreg.png",
       plot = PLOT,
       width=6, height=8,
       device = "png", dpi=600)

PLOT
```

**Make separate table with cellular response data**
```{r Make separate table with cellular response data, echo = TRUE, results = 'hide'}
cellular_response <- serology %>%
  group_by(patid) %>%
  slice_tail() %>%
  filter(patid %in% quantiferon$patid) %>%
  left_join(., select(quantiferon, patid, tb_ag1, tb_ag2))
cellular_response <- cellular_response %>%
  ungroup() %>%
  group_by(status) %>%
  mutate(n = n(), status = case_when(status == "naive" ~ glue("naive\nn = {n}"), status == "experienced" ~ glue("experienced\nn = {n}")))
cellular_response <- cellular_response %>% mutate(
  igg_antispike_log10 = log10(igg_antispike),
  tb_ag2_log10 = log10(tb_ag2),
  tb_ag1_log10 = log10(tb_ag1)
)
```

**Check NT-status association significance in the full model including recovery status instead of igg and another grouping**
```{r Check NT-status association significance in the full model including recovery status instead of igg and another grouping, echo = TRUE, results = 'hide'}
df <- cellular_response %>%
  transmute(patid = as.factor(patid), ifn_ag1 = tb_ag1_log10, ifn_ag2 = tb_ag2_log10, nt50 = neutralization_titre, igg = log10(igg_antispike), recovery_status = status, neutralization_status = as.factor(case_when(
    patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ "not neutralizing\nafter half-a-year",
    TRUE ~ "neutralizing\nafter half-a-year"
  ))) %>%
  left_join(., mutate(clinical_data, patid = as.factor(patid))) %>%
  mutate(recovery_status = factor(str_trim(str_remove(recovery_status, "n = [0-9]*"))))

df <- serology %>%
  transmute(patid = as.factor(patid), time_point, nt50 = neutralization_titre, igg = log10(igg_antispike), recovery_status = status, neutralization_status = as.factor(case_when(
    patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ "not neutralizing\nafter half-a-year",
    TRUE ~ "neutralizing\nafter half-a-year"
  ))) %>%
  left_join(., mutate(clinical_data, patid = as.factor(patid))) %>%
  left_join(., df) %>%
  ungroup()
```


```{r, echo = TRUE, results = 'hide'}
dftmp <- df %>%
  filter(time_point == "T4") %>%
  select(neutralization_status, sex, age, smoking, BMI, recovery_status) %>%
  drop_na() %>%
  mutate(
    neutralization_status = ifelse(arm::rescale(neutralization_status, binary.inputs = "0/1") == 0, 1, 0),
    age = arm::rescale(age, binary.inputs = "0/1"),
    BMI = arm::rescale(BMI, binary.inputs = "0/1"),
    recovery_status = as.factor(recovery_status)
  )

dftmp$recovery_status <- relevel(dftmp$recovery_status, ref = "naive")
fullmod <- glm(neutralization_status ~ ., data = dftmp, family = binomial(link = "logit")) # http://www.stat.columbia.edu/~gelman/research/published/standardizing7.pdf
model_plot_recovery <-
  tidy(fullmod) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    whisker_args = list(color = "black"),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
  ) %>%
  relabel_predictors(c(sexM = "sex (male)", smoking = "smoking", age = "age (scaled)", BMI = "BMI (scaled)", recovery_statusexperienced = "being experienced\n(self reported)")) +
  theme_pubr(base_size = 13) +
  xlab("regression coefficient") +
  ggtitle("+ being experienced\n(self reported)")
```

**IgG levels at T0-T2-T4: fig2**
```{r IgG levels at T0-T2-T4: fig2, fig.width=8, fig.height=8}
model_plots <- vector("list", 5) %>% setNames(paste0("T", 0:4))
TIME_POINT_LABEL <- c("before vaccination", "after 1 dose", "after 2 doses", "T3", "after 6 months") %>% setNames(paste0("T", 0:4))
for (TIME_POINT in paste0("T", 0:4)) {
  dftmp <- df %>%
    filter(time_point == TIME_POINT) %>%
    select(neutralization_status, sex, age, smoking, BMI, igg) %>%
    drop_na() %>%
    mutate(
      neutralization_status = ifelse(arm::rescale(neutralization_status, binary.inputs = "0/1") == 0, 1, 0),
      age = arm::rescale(age, binary.inputs = "0/1"), igg = arm::rescale(igg, binary.inputs = "0/1"), BMI = arm::rescale(BMI, binary.inputs = "0/1")
    )

  fullmod <- glm(neutralization_status ~ ., data = dftmp, family = "binomial")
  model_plots[[TIME_POINT]] <-
    tidy(fullmod) %>%
    dwplot(
      dot_args = list(size = 2, color = "black"),
      whisker_args = list(color = "black"),
      vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
    ) %>%
    relabel_predictors(c(sexM = "sex (male)", smoking = "smoking", age = "age (scaled)", BMI = "BMI (scaled)", igg = glue("anti-S IgG at {TIME_POINT}\n(scaled)"))) +
    theme_pubr(base_size = 13) +
    xlab("regression coefficient") +
    ggtitle(glue("+ anti-S IgG\n{TIME_POINT_LABEL[TIME_POINT]}"))
}
PLOT <- ggarrange(model_plot_recovery, model_plots[[1]], model_plots[[3]], model_plots[[5]], align = "hv", labels = c("A", "B", "C", "D")) +
  plot_annotation("Effects on neutralizing status after 6 months", subtitle = "neutralization ~ sex + smoking + age + BMI +")

ggsave(path = "analysis/plots/vaccination_study/paper/",
       filename = "fig2.png",
       plot = PLOT,
       width=8, height=8,
       device = "png", dpi=600)

PLOT
```

**Check correlation of NT50 between time points to use multivariate regression**
```{r Check correlation of NT50 between time points to use multivariate regression}
df %>%
  select(patid, time_point, nt50) %>%
  pivot_wider(names_from = time_point, values_from = nt50) %>%
  select(-patid) %>%
  drop_na() %>%
  cor() # or GGally::ggpairs()

df %>%
  select(patid, time_point, nt50) %>%
  pivot_wider(names_from = time_point, values_from = nt50) %>%
  select(-c(patid, T4)) %>%
  drop_na() %>%
  cor() # or GGally::ggpairs()
```

**Check correlation of IgG between time points to use multivariate regression**
```{r Check correlation of IgG between time points to use multivariate regression}
df %>%
  select(patid, time_point, igg) %>%
  pivot_wider(names_from = time_point, values_from = igg) %>%
  select(-patid) %>%
  drop_na() %>%
  cor() # or GGally::ggpairs()

df %>%
  select(patid, time_point, igg) %>%
  pivot_wider(names_from = time_point, values_from = igg) %>%
  select(-c(patid, T4)) %>%
  drop_na() %>%
  cor() # or GGally::ggpairs()
```

Yes, both NT50 and IgG auto-correlate through time points, so I can use multivariate regression.

**Check IgG association with clinical parameters**
```{r Check IgG association with clinical parameters}
dftmp <- df %>%
  select(-c(recovery_status, status, neutralization_status, nt50, ifn_ag1, ifn_ag2)) %>%
  pivot_wider(names_from = time_point, values_from = igg) %>%
  mutate(
    BMI = arm::rescale(BMI),
    age = arm::rescale(age)
  ) %>%
  select(-c(patid)) %>%
  drop_na() %>%
  mutate(
    T0 = arm::rescale(T0),
    T1 = arm::rescale(T1),
    T2 = arm::rescale(T2),
    T3 = arm::rescale(T3),
    T4 = arm::rescale(T4)
  )

igg_multivariate_md <- lm(cbind(T0, T1, T2, T3, T4) ~ sex + smoking + age + BMI, data = dftmp)
summary(manova(igg_multivariate_md))
```

**Plot IgG across time model**
```{r Plot IgG across time model, echo = TRUE, results = 'hide'}
p1_igg <- ggstatsplot::ggcoefstats(
  x = manova(igg_multivariate_md),
  output = "tidy"
) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    whisker_args = list(color = "black"),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
  ) %>%
  relabel_predictors(sex = "sex (male)", smoking = "smoking", age = "age\n(scaled)", BMI = "BMI\n(scaled)") +
  theme_pubr(base_size = 15) +
  xlab("% conditional variance ") + ggtitle(TeX("anti-S $IgG_{T0:T4}$ ~")) + scale_x_continuous(labels = seq(0, 1, 0.25) * 100)

p2_igg <- tidy(igg_multivariate_md) %>%
  mutate(model = as.factor(response)) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    vars_order = c("sexM", "smoking", "age", "BMI"),
    whisker_args = list(aes(color = model, group = model), size = 2, color = rep(viridis_pal(option = "viridis")(5), 4)),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2), model_order = c("T0", "T1", "T2", "T3", "T4")
  ) +
  theme_pubr(base_size = 15) +
  xlab("regression coefficients") +
  theme(axis.text.y = element_blank()) +
  ggtitle(TeX("anti-S $IgG_{Ti}$ ~")) +
  geom_line(aes(color = model, x = estimate, y = term), size = 2) +
  scale_color_manual(values = rev(rep(viridis_pal(option = "viridis")(5), 4))) +
  labs(color = "time point")
# Confidence intervals can be asymmetric since bootstrapping was used.
```

**Check NT50 association with clinical parameters**
```{r Check NT50 association with clinical parameters}
dftmp <- df %>%
  select(-c(recovery_status, status, neutralization_status, igg, ifn_ag1, ifn_ag2)) %>%
  pivot_wider(names_from = time_point, values_from = nt50) %>%
  mutate(
    BMI = arm::rescale(BMI),
    age = arm::rescale(age)
  ) %>%
  select(-c(patid)) %>%
  drop_na() %>%
  mutate(
    T0 = arm::rescale(T0),
    T1 = arm::rescale(T1),
    T2 = arm::rescale(T2),
    T3 = arm::rescale(T3),
    T4 = arm::rescale(T4)
  )

nt50_multivariate_md <- lm(cbind(T0, T1, T2, T3, T4) ~ sex + smoking + age + BMI, data = dftmp)
summary(manova(nt50_multivariate_md))
```

Age is kinda significant on the T0 for both IgG and NT50 - check whether there is no bias according to the status

```{r suppl_no_age_bias_check, fig.width=4, fig.height=4}
no_age_bias_check <- serology %>%
  filter(time_point == "T0") %>%
  mutate(age = as.numeric(date - date_of_birth) / 365) %>%
  ungroup() %>%
  select(age, status) %>%
  ggplot(aes(status, age)) +
  geom_violin(size = 0.5) +
  geom_beeswarm(size = 2) +
  geom_boxplot(width = 0.1, color = "black", alpha = 0.3) +
  theme_pubr(base_size = 15)

# ggsave(path = "analysis/plots/vaccination_study/paper/",
#        filename = "suppl_no_age_bias_check.png",
#        plot = no_age_bias_check,
#        width=4, height=4,
#        device = "png", dpi=300)

no_age_bias_check
```

**Plot NT50 across time model**
```{r Plot NT50 across time model, echo = TRUE, results = 'hide'}
p1_nt50 <- ggstatsplot::ggcoefstats(
  x = manova(nt50_multivariate_md),
  output = "tidy"
) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    whisker_args = list(color = "black"),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
  ) %>%
  relabel_predictors(sex = "sex (male)", smoking = "smoking", age = "age\n(scaled)", BMI = "BMI\n(scaled)") +
  theme_pubr(base_size = 15) +
  xlab("% conditional variance ") + ggtitle(TeX("$NT50_{T0:T4}$ ~")) + scale_x_continuous(labels = seq(0, 1, 0.25) * 100)

p2_nt50 <- tidy(nt50_multivariate_md) %>%
  mutate(model = as.factor(response)) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    vars_order = c("sexM", "smoking", "age", "BMI"),
    whisker_args = list(aes(color = model, group = model), size = 2, color = rep(viridis_pal(option = "viridis")(5), 4)),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2), model_order = c("T0", "T1", "T2", "T3", "T4")
  ) +
  theme_pubr(base_size = 15) +
  xlab("regression coefficients") +
  theme(axis.text.y = element_blank()) +
  ggtitle(TeX("$NT50_{Ti}$ ~")) + # ggtitle("NT50 ~ sex + smoking + age + BMI") +
  geom_line(aes(color = model, x = estimate, y = term), size = 2) +
  scale_color_manual(values = rev(rep(viridis_pal(option = "viridis")(5), 4))) +
  labs(color = "time point")

plots <- ggarrange(p1_igg, p2_igg, p1_nt50, p2_nt50, common.legend = TRUE, labels = c("B", "C", "D", "E"))
```

**fig3**
```{r, echo = TRUE, results = 'hide'}
serology_correlation_plots <- vector("list", 5) %>% setNames(paste0("T", 0:4))

for (TIME_POINT in paste0("T", 0:4)) {
  nt50_vs_igg <- serology %>%
    filter(time_point == TIME_POINT) %>%
    transmute(patid, neutralization_titre, igg_antispike_log10 = log10(igg_antispike), status) %>%
    ungroup() %>%
    group_by(status) %>%
    mutate(
      n = n(),
      status_n = case_when(
        status == "naive" ~ glue("naive\nn = {n}"),
        status == "experienced" ~ glue("experienced\nn = {n}")
      )
    )
  pmain <- ggscatter(nt50_vs_igg,
    x = "neutralization_titre", y = "igg_antispike_log10",
    palette = c("#D55E00", "#56B4E9"),
    add = "reg.line", add.params = list(color = "status", fill = "lightgray"), conf.int = FALSE
  ) +
    stat_cor(aes(color = status), method = "spearman", cor.coef.name = "rho", size = 3) +
    xlab(TeX("$_{-log_{10}}$ NT50")) +
    ylab(TeX("$_{log_{10}}$ anti-S IgG $_{(BAU/ml)}$")) +
    theme_pubr(base_size = 15) +
    theme(legend.title = element_blank())

  xlab <- pmain$labels$x
  ylab <- pmain$labels$y
  plot_legend <- get_legend(pmain)

  pmain <- ggscatter(nt50_vs_igg,
    x = "neutralization_titre", y = "igg_antispike_log10",
    color = "status", alpha = 0.5, shape = 10, palette = c("#D55E00", "#56B4E9"),
    add = "reg.line", add.params = list(color = "status", fill = "lightgray"), conf.int = FALSE, size = 1
  ) +
    stat_cor(aes(color = status),
      method = "spearman",
      cor.coef.name = "rho",
      size = 5,
      digits = 2,
      label.sep = "\n",
      label.x.npc = c(0.005, 0.5),
      label.y.npc = c(0.9, 0.65)
    ) +
    theme_pubr(base_size = 12) +
    theme(legend.position = "none") +
    xlab("") +
    ylab("") +
    scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
    scale_x_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1)))))

  xdens <- axis_canvas(pmain, axis = "x") +
    geom_density(
      data = nt50_vs_igg,
      aes(x = neutralization_titre, fill = status),
      alpha = 0.3, size = 0.2
    ) +
    fill_palette(palette = c("#D55E00", "#56B4E9"))

  ydens <- axis_canvas(pmain, axis = "y", coord_flip = TRUE) +
    geom_density(
      data = nt50_vs_igg,
      aes(x = igg_antispike_log10, fill = status),
      alpha = 0.5, size = 0.2
    ) +
    coord_flip() +
    fill_palette(palette = c("#D55E00", "#56B4E9"))

  pmain <- insert_xaxis_grob(pmain, xdens, grid::unit(.1, "null"), position = "top")
  pmain <- insert_yaxis_grob(pmain, ydens, grid::unit(.1, "null"), position = "right")

  serology_correlation_plots[[TIME_POINT]] <- ggdraw(pmain)
  rm(pmain, xdens, ydens)
}


nt50_vs_igg <- ggarrange(serology_correlation_plots[[1]],
  serology_correlation_plots[[2]],
  serology_correlation_plots[[3]],
  serology_correlation_plots[[4]],
  serology_correlation_plots[[5]],
  ncol = 1, legend = "top", legend.grob = plot_legend,
  labels = paste0("T", 0:4), label.x = 0.05, font.label = list(size = 11, face = c("bold.italic"))
)
nt50_vs_igg <- annotate_figure(nt50_vs_igg,
  left = text_grob(ylab, rot = 90, size = 15),
  bottom = text_grob(xlab, size = 15)
)
```


```{r fig3, fig.width=10, fig.height=15}
fig3 <- ggarrange(nt50_vs_igg, plots, widths = c(2, 4), labels = "A")

# ggsave(path = "analysis/plots/vaccination_study/paper/",
#        filename = "fig3.png",
#        plot = fig3,
#        width=10, height=15,
#        device = "png", dpi=600)

fig3
```

**Correlate serological and cellular response on the last time point**
```{r Correlate serological and cellular response on the last time point, echo = TRUE, results = 'hide'}
pmain <- function(XAXIS, YAXIS, label_xaxis, label_yaxis, legend = FALSE) {
  p <- ggscatter(cellular_response,
    x = XAXIS, y = YAXIS,
    alpha = 0.75,
    color = "status", shape = 10, palette = c("#D55E00", "#56B4E9"),
    add = "reg.line", add.params = list(color = "status"), conf.int = FALSE
  ) +
    stat_cor(aes(color = status),
      method = "spearman", cor.coef.name = "rho", size = 4.5,
      digits = 2,
      label.sep = "\n",
      label.x.npc = c(0.005, 0.5),
      label.y.npc = c(0.9, 0.55)
    ) +
    theme_pubr(base_size = 12) +
    theme(legend.position = "none") +
    scale_y_continuous(labels = function(x) sprintf("%.1f", x)) #+theme(plot.margin=unit(c(0,0,-0.5,-0.5),"cm"))
  if (legend == TRUE) p <- p + theme(legend.position = "top", legend.title = element_blank())
  if (label_xaxis) {
    p <- p + xlab(ifelse(str_detect(XAXIS, "ag1"), TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag1"), TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag2")))
  } else {
    p <- p + xlab("")
  }

  if (label_yaxis) {
    p <- p + ylab(ifelse(str_detect(YAXIS, "igg"), TeX("$_{log_{10}}$ anti-S IgG $_{(BAU/ml)}$"), TeX("$_{-log_{10}}$ NT50")))
  } else {
    p <- p + ylab("")
  }
}
xdens <- function(PMAIN, XAXIS) {
  axis_canvas(PMAIN, axis = "x") +
    geom_density(
      data = cellular_response,
      aes(x = cellular_response[[XAXIS]], fill = status),
      alpha = 0.3, size = 0.2
    ) +
    theme(legend.title = element_blank()) +
    fill_palette(palette = c("#D55E00", "#56B4E9")) #+theme(plot.margin=unit(c(-0.5,0,-0.5,-0.5),"cm"))
}
ydens <- function(PMAIN, YAXIS) {
  axis_canvas(PMAIN, axis = "y", coord_flip = TRUE) +
    geom_density(
      data = cellular_response,
      aes(x = cellular_response[[YAXIS]], fill = status),
      alpha = 0.3, size = 0.2
    ) +
    coord_flip() +
    theme(legend.title = element_blank()) +
    fill_palette(palette = c("#D55E00", "#56B4E9")) #+theme(plot.margin=unit(c(0,-0.5,-0.5,0),"cm"))
}

pempty <- ggplot() +
  theme_void()

pmain_ag1_igg <- pmain("tb_ag1_log10", "igg_antispike_log10", FALSE, TRUE, TRUE) + ylim(1.75, 3.75)
plot_legend <- get_legend(pmain_ag1_igg)
pmain_ag1_igg <- pmain("tb_ag1_log10", "igg_antispike_log10", FALSE, TRUE) + xlim(-1.5, 1.05) + scale_y_continuous(labels = label_number(accuracy = 0.1), limits = c(1.75, 3.75))
pmain_ag2_igg <- pmain("tb_ag2_log10", "igg_antispike_log10", FALSE, FALSE) + xlim(-1.5, 1.05) + scale_y_continuous(labels = label_number(accuracy = 0.1), limits = c(1.75, 3.75))
pmain_ag1_nt50 <- pmain("tb_ag1_log10", "neutralization_titre", TRUE, TRUE) + xlim(-1.5, 1.05) + scale_y_continuous(labels = label_number(accuracy = 0.1), limits = c(0, 3))
pmain_ag2_nt50 <- pmain("tb_ag2_log10", "neutralization_titre", TRUE, FALSE) + xlim(-1.5, 1.05) + scale_y_continuous(labels = label_number(accuracy = 0.1), limits = c(0, 3))
xdens_ag1 <- xdens(pmain_ag1_igg, "tb_ag1_log10")
xdens_ag2 <- xdens(pmain_ag2_igg, "tb_ag2_log10")
ydens_igg <- ydens(pmain_ag1_igg, "igg_antispike_log10")
ydens_nt50 <- ydens(pmain_ag2_nt50, "neutralization_titre")

pmain_ag1_igg <- insert_xaxis_grob(pmain_ag1_igg, xdens_ag1, grid::unit(.1, "null"), position = "top")
pmain_ag2_igg <- insert_xaxis_grob(pmain_ag2_igg, xdens_ag2, grid::unit(.1, "null"), position = "top")
pmain_ag2_igg <- insert_yaxis_grob(pmain_ag2_igg, ydens_igg, grid::unit(.1, "null"), position = "right")
pmain_ag2_nt50 <- insert_yaxis_grob(pmain_ag2_nt50, ydens_nt50, grid::unit(.1, "null"), position = "right")
p1 <- ggarrange(as_ggplot(plot_legend),
  ggarrange(
    pmain_ag1_igg, pmain_ag2_igg,
    pmain_ag1_nt50, pmain_ag2_nt50,
    widths = c(1, 1.075)
  ),
  ncol = 1, heights = c(0.1, 2)
)
```

suppl_ifn_associations
```{r suppl_ifn_associations, fig.width=8, fig.height=3}
dftmp <- df %>%
  filter(!is.na(ifn_ag1)) %>%
  select(-c(patid, time_point, igg, nt50, recovery_status, neutralization_status)) %>%
  drop_na() %>%
  mutate(age = arm::rescale(age), BMI = arm::rescale(BMI), ifn_ag1 = arm::rescale(ifn_ag1), ifn_ag2 = arm::rescale(ifn_ag2))


# # Forward selection check
fullmod <- lm(ifn_ag1 ~ sex + smoking + age + BMI, data = dftmp)
# nothing <- lm(ifn_ag1 ~ 1, data = dftmp)
# stats::step(nothing, scope=list(lower=formula(nothing),upper=formula(fullmod)), direction="forward") # age, weakly

ag1_mod <-
  tidy(fullmod) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    whisker_args = list(color = "black"),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
  ) %>%
  relabel_predictors(c(sexM = "sex (male)", smoking1 = "smoking", age = "age\n(scaled)", BMI = "BMI\n(scaled)")) +
  theme_pubr(base_size = 12) +
  xlab("regression coefficient") +
  ggtitle(label = element_blank(), subtitle = TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag1 ~"))

fullmod <- lm(ifn_ag2 ~ sex + smoking + age + BMI, data = dftmp)
ag2_mod <-
  tidy(fullmod) %>%
  dwplot(
    dot_args = list(size = 2, color = "black"),
    whisker_args = list(color = "black"),
    vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)
  ) %>%
  relabel_predictors(c(sexM = "sex (male)", smoking1 = "smoking", age = "age\n(scaled)", BMI = "BMI\n(scaled)")) +
  theme_pubr(base_size = 12) +
  xlab("regression coefficient") +
  ggtitle(label = element_blank(), subtitle = TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag2 ~")) +
  theme(axis.text.y = element_blank())

# plot_grid(
#   plot_grid(ag1_mod, NULL, ag2_mod, NULL, nrow = 1, rel_widths = c(1,0.2,0.8,0.1)),
#   p1,
#   ncol = 1,
#   rel_heights = c(1,2.5)
# )

PLOT <- ag1_mod + ag2_mod

# ggsave(path = "analysis/plots/vaccination_study/paper/",
#        filename = "suppl_ifn_associations.png",
#        plot = PLOT,
#        width=8, height=4,
#        device = "png", dpi=300)

PLOT
```

**IFN comparison between statuses: fig4**
```{r IFN comparison between statuses: fig4, fig.width=10, fig.height=15}
df <- cellular_response %>%
  ungroup() %>%
  mutate(
    neutralization_status = as.factor(case_when(
      patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ "non-neutralizing\nafter 6 months",
      TRUE ~ "neutralizing\nafter 6 months"
    ))
  )

sample_size <- df %>%
  group_by(neutralization_status) %>%
  summarize(num = n())

df <- cellular_response %>%
  ungroup() %>%
  mutate(
    neutralization_status = as.factor(case_when(
      patid %in% c(patients_wo_neutralization_at_all, patients_wo_neutralization_after_halfayear) ~ glue("non-neutralizing after 6 months\nn = {sample_size$num[2]}"),
      TRUE ~ glue("neutralizing after 6 months\nn = {sample_size$num[1]}")
    ))
  )

ifn_neutralization_ag1 <- df %>%
  left_join(sample_size) %>%
  mutate(myaxis = paste0(neutralization_status, "\n", "n = ", num)) %>%
  ggplot(aes(myaxis, tb_ag1_log10, group = neutralization_status, color = neutralization_status)) +
  stat_compare_means(label.y.npc = 0.1, label.x = 1.5, size = 4) +
  geom_violin(size = 0.5) +
  geom_beeswarm(size = 2) +
  scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07", "#999999")) +
  geom_boxplot(width = 0.1, color = "black", alpha = 0.3) +
  theme_pubr(base_size = 12) +
  ylab(TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag1")) +
  xlab("") +
  coord_flip() + #+ theme(legend.position = "none")
  theme(
    axis.text.y = element_blank(),
    legend.title = element_blank()
  ) +
  ylim(-1.5, 1.05)

ifn_neutralization_ag2 <- df %>%
  left_join(sample_size) %>%
  mutate(myaxis = paste0(neutralization_status, "\n", "n = ", num)) %>%
  ggplot(aes(myaxis, tb_ag2_log10, group = neutralization_status, color = neutralization_status)) +
  stat_compare_means(label.y.npc = 0.1, label.x = 1.5, size = 4) +
  geom_violin(size = 0.5) +
  geom_beeswarm(size = 2, ) +
  scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07", "#999999")) +
  geom_boxplot(width = 0.1, color = "black", alpha = 0.3) +
  theme_pubr(base_size = 12) +
  ylab(TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag2")) +
  xlab(label = element_blank()) +
  coord_flip() + #+ theme(legend.position = "none")
  theme(
    axis.text.y = element_blank(),
    legend.title = element_blank()
  ) +
  ylim(-1.5, 1.05)



ifn_recovery_ag1 <- cellular_response %>%
  ggplot(aes(status, tb_ag1_log10, color = status)) +
  stat_compare_means(label.y.npc = 0.1, label.x = 1.5, size = 4) +
  geom_violin(size = 0.5) +
  geom_beeswarm(size = 2) +
  geom_boxplot(width = 0.1, color = "black", alpha = 0.3) +
  theme_pubr(base_size = 12) +
  ylab(TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag2")) +
  xlab("") +
  # theme(legend.position = "none") +
  coord_flip() +
  scale_color_manual(values = c("#D55E00", "#56B4E9")) +
  theme(
    axis.text.y = element_blank(),
    legend.title = element_blank()
  ) +
  ylim(-1.5, 1.05)


ifn_recovery_ag2 <- cellular_response %>%
  ggplot(aes(status, tb_ag2_log10, color = status)) +
  stat_compare_means(label.y.npc = 0.1, label.x = 1.5, size = 4) +
  geom_violin(size = 0.5) +
  geom_beeswarm(size = 2) +
  geom_boxplot(width = 0.1, color = "black", alpha = 0.3) +
  theme_pubr(base_size = 12) +
  ylab(TeX("$_{log_{10}}$ QuantiFERON SARS-CoV-2 Ag2")) +
  xlab(label = element_blank()) +
  coord_flip() +
  # theme(legend.position = "none") +
  scale_color_manual(values = c("#D55E00", "#56B4E9")) +
  theme(
    axis.text.y = element_blank(),
    legend.title = element_blank()
  ) +
  ylim(-1.5, 1.05)



fig4 <- plot_grid(
    ggarrange(NULL, ifn_recovery_ag1, NULL, ifn_recovery_ag2, NULL, nrow = 1, common.legend = TRUE, widths = c(0.05, 1, 0.125, 1, 0.075)),
  ggarrange(NULL, ifn_neutralization_ag1, NULL, ifn_neutralization_ag2, NULL, nrow = 1, common.legend = TRUE, widths = c(0.05, 1, 0.125, 1, 0.075)),
  p1,
  ncol = 1, rel_heights = c(1, 1, 2), labels = c("A", "B", "C")
)

ggsave(
  path = "analysis/plots/vaccination_study/paper/",
  filename = "fig4.png",
  plot = fig4,
  width = 10, height = 15,
  device = "png", dpi = 600
)

fig4
```

```{r}
sessionInfo()
```

